(function($){$.fn.dragndrop=function(options){var rowCount=0;var mainObject=$(this);var singleStatusObject=null;var galleryImagesIndex=0;var isEventSupported=function(){var TAGNAMES={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};function isEventSupported(eventName,element){element=element||document.createElement(TAGNAMES[eventName]||"div");eventName="on"+eventName;var isSupported=eventName in element;if(!isSupported){if(!element.setAttribute){element=document.createElement("div")}if(element.setAttribute&&element.removeAttribute){element.setAttribute(eventName,"");isSupported=typeof element[eventName]=="function";if(typeof element[eventName]!="undefined"){element[eventName]=undefined}element.removeAttribute(eventName)}}element=null;return isSupported}return isEventSupported}();var isFileAPIEnabled=function(){return!!window.FileReader};function preUploadDefensive(){if($.inArray(uploadType,["file","image","gallery"])<0){return false}if(!uploadTarget){return false}}function handleFileUpload(files,obj){for(var i=0;i<files.length;i++){if(uploadValidation(files[i])){var fd=new FormData;fd.append("dragFile",files[i]);var uniqueId=Date.now();var singleElement=$("<div>").attr("id","div_media_single_"+uniqueId).addClass("reditemDragnDrop-single-element");$("#statusBar_"+uploadTarget).after(singleElement);var status=new createStatusbar($(singleElement));status.setFileNameSize(files[i].name,files[i].size);sendFileToServer(fd,status,singleElement)}}}function createStatusbar(obj){rowCount++;var row="odd";if(rowCount%2==0)row="even";this.statusbar=$("<div class='statusbar "+row+" status_"+rowCount+"'></div>");this.filename=$("<div class='filename'></div>").appendTo(this.statusbar);this.size=$("<div class='filesize'></div>").appendTo(this.statusbar);this.progressBar=$("<div class='progressBar'><div></div></div>").appendTo(this.statusbar);this.abort=$("<div class='abort'>"+Joomla.JText._("COM_REDITEM_UPLOAD_ABORT")+"</div>").appendTo(this.statusbar);obj.append(this.statusbar);this.setFileNameSize=function(name,size){var fieldCode=mainObject.attr("target");var sizeStr="";var sizeKB=size/1024;if(parseInt(sizeKB)>1024){var sizeMB=sizeKB/1024;sizeStr=sizeMB.toFixed(2)+" MB"}else{sizeStr=sizeKB.toFixed(2)+" KB"}this.filename.html(name);$("#jform_fields_file_names_"+fieldCode).val(name);$("#jform_fields_images_"+fieldCode+"_media_preview").html("");$("#jform_fields_media_"+fieldCode).val("");$("#img-crop-"+fieldCode).remove();$("#"+fieldCode+"_current").remove();this.size.html(sizeStr)};this.setProgress=function(progress){var progressBarWidth=progress*this.progressBar.width()/100;this.progressBar.find("div").animate({width:progressBarWidth},10).html(progress+"% ");if(parseInt(progress)>=100){this.abort.hide()}};this.setAbort=function(jqxhr){var sb=this.statusbar;this.abort.click(function(){jqxhr.abort();sb.hide()})}}function sendFileToServer(formData,status,parentDiv){var uploadURL=options.url;var jqXHR=jQuery.ajax({xhr:function(){var xhrobj=jQuery.ajaxSettings.xhr();if(xhrobj.upload){xhrobj.upload.addEventListener("progress",function(event){var percent=0;var position=event.loaded||event.position;var total=event.total;if(event.lengthComputable){percent=Math.ceil(position/total*100)}status.setProgress(percent)},false)}return xhrobj},url:uploadURL+"&uploadType="+uploadType+"&uploadTarget="+uploadTarget+"&fieldType="+fieldType,type:"POST",contentType:false,processData:false,cache:false,data:formData,success:function(data){responseHandlerProcess(data,status,parentDiv)}});status.setAbort(jqXHR)}function responseHandlerProcess(data,status,parentDiv){status.setProgress(100);if(uploadType=="file"){$("#jform_fields_dragndrop_upload"+uid).val(data.trim())}if(uploadType=="gallery"){$("#jform_fields_dragndrop_upload"+uid).val($("#jform_fields_dragndrop_upload"+uid).val()+","+data.trim());status.deleteFile=$("<div class='deleteFile'><a class='btn btn-danger dragndrop-delete-file'><i class='icon-remove'></i>"+Joomla.JText._("COM_REDITEM_UPLOAD_DELETE_FILE")+"</a></div>").appendTo(status.statusbar);if(!Date.now){Date.now=function(){return(new Date).getTime()}}status.preview=$("#gallery_preview_"+uindex);var uindex=Date.now();var imgPreview=$(parentDiv);galleryImagesIndex=$('input[name="jform[customfield_gallery_default]['+uploadTarget+']"]').length;imgPreview.append('<div id="div_media_'+uindex+'" class="media"><div class="img-preview-container" style="position:relative;"><img id="gallery_preview_'+uindex+'" src="" class="img-polaroid" style="max-width: 100%; max-height: 100%;" /><label class="radio" for="reditemGallery-DefaultImage-Index-'+uindex+'"><input id="reditemGallery-DefaultImage-Index-'+uindex+'" class="reditem_gallery_default_image_index" type="radio" name="jform[customfield_gallery_default]['+uploadTarget+']" value="'+galleryImagesIndex+'" /> '+Joomla.JText._("COM_REDITEM_CUSTOMFIELD_GALLERY_SET_DEFAULT")+"</label></div></div>");var preview=$("#gallery_preview_"+uindex);updateImageDefaultIndex();status.deleteFile.click(function(){$("#jform_fields_dragndrop_upload"+uid).val($("#jform_fields_dragndrop_upload"+uid).val().replace(","+data.trim(),""));status.statusbar.remove();$("#div_media_"+uindex).parent().remove();updateImageDefaultIndex()})}if(uploadType=="image"){if(singleStatusObject!=null){$("#"+singleStatusObject).find(".deleteFile").click();$("#"+singleStatusObject).remove();singleStatusObject=$(parentDiv).attr("id")}else{singleStatusObject=$(parentDiv).attr("id")}$("#jform_fields_dragndrop_upload"+uid).val(data.trim());if(options.hasOwnProperty("img_hidden_value")){var img_hidden=$("#"+options.img_hidden_value);img_hidden.val(data.trim())}status.deleteFile=$("<div class='deleteFile'><a class='btn btn-danger dragndrop-delete-file'><i class='icon-remove'></i>"+Joomla.JText._("COM_REDITEM_UPLOAD_DELETE_FILE")+"</a></div>").appendTo(status.statusbar);var imgPreview=$("#"+img_preview);if(!$("#img_preview_"+uploadTarget).length){imgPreview.prepend('<div class="pull-left"><div class="img-preview-container" style="position:relative;"><img id="img_preview_'+uploadTarget+'" src="" class="img-polaroid" style="max-width: 300px; max-height: 300px; margin-right: 20px" /></div></div>')}$("#img_preview_"+uploadTarget).attr("src",img_preview_path+data.trim());status.deleteFile.click(function(){$("#jform_fields_dragndrop_upload"+uid).val("");$(imgPreview).find(".img-preview-container").remove();$("#img_preview_"+uploadTarget).remove();status.statusbar.remove();if(defaultImgPath!=""){var imgPreviewContainer=$("<div>");$(imgPreviewContainer).addClass("img-preview-container").css("position","relative");$("<img>").attr("id","img_preview_"+uploadTarget).attr("src",defaultImgPath).addClass("img-polaroid").css("max-width",previewWidth+"px").css("max-height",previewHeight+"px").css("margin-right","20px").appendTo($(imgPreviewContainer));$(imgPreviewContainer).appendTo($(imgPreview))}})}}function generateUid(separator){var delim=separator||"-";function S4(){return((1+Math.random())*65536|0).toString(16).substring(1)}return S4()+S4()+delim+S4()+delim+S4()+delim+S4()+delim+S4()+S4()+S4()}function uploadValidation(file){if(file.type==""){alert(Joomla.JText._("COM_REDITEM_UPLOAD_FILE_INVALID"));return false}else{var extTemp=file.name.split(".");if($.inArray(extTemp[extTemp.length-1],allowExt)<0){alert(Joomla.JText._("COM_REDITEM_UPLOAD_FILE_INVALID"));return false}}if(file.size==0){alert(Joomla.JText._("COM_REDITEM_UPLOAD_FILE_INVALID"));return false}if(allowSize>0){if(file.size>allowSize){alert(Joomla.JText._("COM_REDITEM_UPLOAD_FILE_TOO_BIG"));return false}}return true}function updateImageDefaultIndex(){if($(mainObject).parent().find(".reditemDragnDrop-single-element").length>0){var count=$(mainObject).parent().find(".reditemDragnDrop-single-element").length;$(mainObject).parent().find(".reditemDragnDrop-single-element").each(function(index){var value=count-index;var optionObj=$(this).find(".reditem_gallery_default_image_index");$(optionObj).val(value)});if($(mainObject).parent().find('.reditemDragnDrop-single-element input.reditem_gallery_default_image_index[type="radio"]:checked').length<=0){$(mainObject).parent().find('.reditemDragnDrop-single-element input.reditem_gallery_default_image_index[type="radio"]').first().prop("checked",true)}}}if(isEventSupported("dragenter")&&isEventSupported("dragover")&&isEventSupported("drop")){var uploadType=mainObject.attr("upload-type");var uploadTarget=mainObject.attr("target");var inputTarget=mainObject.attr("input-target");if($("#"+inputTarget).prop("required")){$("#"+inputTarget).prop("required",false);$("#"+uploadTarget).prop("required",true)}preUploadDefensive();var uid=generateUid("_");var dragText=options["text"];var keepOldProcessBar=0;if(uploadType=="image"){dragText=Joomla.JText._("COM_REDITEM_ITEM_DRAG_AN_IMAGE")}if(uploadType=="gallery"){dragText=Joomla.JText._("COM_REDITEM_ITEM_DRAG_IMAGES")}if(!isFileAPIEnabled()){dragText=Joomla.JText._("COM_REDITEM_ITEM_DRAG_FEATURE_NOT_SUPPORT")}var includeBrowse=0;if(options.config.hasOwnProperty("includeBrowse")){includeBrowse=parseInt(options.config.includeBrowse);if(isNaN(includeBrowse))includeBrowse=0}mainObject.after('<div id="statusBar_'+uploadTarget+'"></div>');mainObject.after('<div id="reditem_dragselect_'+uid+'" class="dragselect">'+dragText+"</div>");mainObject.after('<input type="hidden" id="jform_fields_dragndrop_upload'+uid+'" name="jform[fields][dragndrop]['+uploadTarget+'][]" value="" />');if(includeBrowse==1&&isFileAPIEnabled()){$("<span>").attr("href","javascript:void(0)").html(Joomla.JText._("COM_REDITEM_ITEM_DRAG_AND_DROP_BROWSE")).appendTo($("#reditem_dragselect_"+uid)).click(function(event){event.preventDefault();$("#"+inputTarget).click()})}if(!isFileAPIEnabled()){$("<input>").attr("type","file").attr("name","dragFile").appendTo($("#reditem_dragselect_"+uid)).ajaxfileupload({action:options.url+"&uploadType="+uploadType+"&uploadTarget="+uploadTarget+"&fieldType="+fieldType,params:{extra:"info"},onComplete:function(response){if($("#"+inputTarget).attr("old-name"))$("#"+inputTarget).attr("name",$("#"+inputTarget).attr("old-name")).removeAttr("old-name");var uniqueId=Date.now();var singleElement=$("<div>").attr("id","div_media_single_"+uniqueId).addClass("reditemDragnDrop-single-element");$("#statusBar_"+uploadTarget).after(singleElement);var status=new createStatusbar($(singleElement));responseHandlerProcess(response,status,singleElement)},onStart:function(){$("#"+inputTarget).attr("old-name",$("#"+inputTarget).attr("name")).attr("name","dragFile")},onCancel:function(){if($("#"+inputTarget).attr("old-name"))$("#"+inputTarget).attr("name",$("#"+inputTarget).attr("old-name")).removeAttr("old-name")}})}var obj=$("#reditem_dragselect_"+uid);var files=null;var allowExt=options.config.ext.split(",");var allowSize=-1;if(options.config.hasOwnProperty("size")){try{allowSize=parseInt(options.config.size)}catch(err){allowSize=-1}}if(options.config.hasOwnProperty("keepOldProcessBar")){try{keepOldProcessBar=parseInt(options.config.keepOldProcessBar)}catch(err){keepOldProcessBar=0}}var img_preview="";if(options.hasOwnProperty("img_preview")){try{img_preview=options.img_preview}catch(err){img_preview=""}}var img_preview_path="";if(options.hasOwnProperty("img_preview_path")){try{img_preview_path=options.img_preview_path}catch(err){img_preview_path=""}}var fieldType="item";if(options.hasOwnProperty("fieldType")){try{fieldType=options.fieldType}catch(err){fieldType="item"}}var defaultImgPath="";if(options.hasOwnProperty("default_img")){try{defaultImgPath=options.default_img}catch(error){defaultImgPath=""}}var previewWidth="300";var previewHeight="300";var keepRatio=false;obj.on("dragenter",function(e){e.stopPropagation();e.preventDefault()});obj.on("dragover",function(e){e.stopPropagation();e.preventDefault()});obj.on("drop",function(e){e.preventDefault();if(e.type==="drop"&&isFileAPIEnabled()){preUploadDefensive();files=!e.dataTransfer?e.originalEvent.dataTransfer.files:e.dataTransfer.files;if(!keepOldProcessBar&&uploadType!="gallery"){$("#statusBar_"+uploadTarget).empty()}if((uploadType=="file"||uploadType=="image")&&files.length>1){alert(Joomla.JText._("COM_REDITEM_UPLOAD_1_FILE_ONLY"));return}handleFileUpload(files,obj)}});$(document).on("dragenter",function(e){e.stopPropagation();e.preventDefault()});$(document).on("dragover",function(e){e.stopPropagation();e.preventDefault();obj.css("border","2px dotted #0B85A1")});$(document).on("drop",function(e){e.stopPropagation();e.preventDefault()});this.addInputTarget=function(inputTarget){if(isFileAPIEnabled()){$("#"+inputTarget).on("change",function(e){e.preventDefault();preUploadDefensive();files=e.originalEvent.target.files;if(!keepOldProcessBar&&uploadType!="gallery"){$("#statusBar_"+uploadTarget).empty()}if((uploadType=="file"||uploadType=="image")&&files.length>1){alert(Joomla.JText._("COM_REDITEM_UPLOAD_1_FILE_ONLY"));return}handleFileUpload(files,obj)})}};if(inputTarget!=null&&isFileAPIEnabled()){this.addInputTarget(inputTarget)}return this}}})(jQuery);
